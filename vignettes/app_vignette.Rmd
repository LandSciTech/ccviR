---
title: "Using the ccviR app"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the ccviR app}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Introduction
The ccviR app implements the [NatureServe Climate Change Vulnerability Index (CCVI)](https://www.natureserve.org/conservation-tools/climate-change-vulnerability-index) in a Shiny App. The app allows all of the geospatial aspects of calculating the CCVI to be done in R, removing the need for separate GIS calculations. It also includes new features and enhanced user friendliness to make it easier to calculate the index and explore the results. 

The NatureServe CCVI is a trait based climate change vulnerability assessment framework that can also include observed and modeled responses to climate change. The NatureServe CCVI includes three commonly used components of vulnerability: exposure, sensitivity and adaptive capacity and optionally incorporates the results of documented or modeled responses to climate change. Exposure is assessed by determining the proportion of the species range that falls into 6 classes of temperature and moisture change, which is used to determine an exposure multiplier. Sensitivity and adaptive capacity and responses to climate change are assessed by scoring vulnerability factors (23 and 4 respectively), on a scale from ‘neutral’ (0)  to ‘greatly increases vulnerability’ (3). Factors that cannot be answered can be left blank and contribute 0 to the total score, but if fewer than 13 are scored the index value can not be calculated. The sensitivity and adaptive capacity section scores are then multiplied by an exposure multiplier and summed, while the scores for the response to climate change section are simply summed. An index value is then determined for each section by applying a set of thresholds to the scores. The two index values are then combined using a table that gives more weight to the sensitivity and adaptive capacity section (Young 2012, Young 2015). The possible index values are Less Vulnerable, Moderately Vulnerable, Highly Vulnerable, Extremely Vulnerable or Insufficient Evidence if not enough factors of the CCVI are scored. For more detailed information on how the index works and how each factor is scored see the [NatureServe CCVI Guidelines](https://www.natureserve.org/sites/default/files/guidelines_natureserveclimatechangevulnerabilityindex_r3.02_1_jun_2016.pdf) and the references below.

## Launching the app
The app is launched by calling the `run_ccvi_app()` function, which will launch the app in the user's default internet browser. All file selection windows will start in the current working directory. To run the app with data stored in a different folder you can call `run_ccvi_app()` with the folder path as the first argument. For example if all of the data is stored in a subdirectory named "data" of the RStudio project where I am calling the function I would call `run_ccvi_app("data")` to avoid having to open the data folder every time I select a file. Alternatively, the complete path to the data folder can be supplied e.g. "C:/Users/username/Documents/path/to/folder" (Note that paths in R must be supplied using forward slashes). 

## Preparing the data
The first time you use the app you will need to prepare the climate data used in the app. There is a tool with in the app that has instructions for how to do this. You will download a climate data set with bioclimatic variables for two time periods and then tell the app where this is stored and where to store the prepared data. The app will use the raw climate data that you have downloaded to create the inputs that are used in the app which are classified versions of the climate data. 

In addition to the climate data, you will need to gather several data sets for each species to be assessed. These are listed on the first page of the app and include the species' range and the assessment area that the species is being assessed within. 

## Using the app
The first tab contains information about the species being assessed. Once all mandatory fields are filled in click next. The second tab is where the data will be loaded and displayed on an interactive map. The climate data is loaded by selecting the location where you have stored the prepared climate data. Other files must be selected individually. Click Run to perform the spatial calculations and view the data on an interactive map and a table showing the exposure multiplier derived from the temperature and moisture data. The third tab includes questions on the species vulnerability to climate change that can be answered based on expert knowledge and/or a literature review. The NatureServe CCVI [guidelines](https://www.natureserve.org/sites/default/files/guidelines_natureserveclimatechangevulnerabilityindex_r3.02_1_jun_2016.pdf) explain how to interpret each question and are provided as a pop-up in the app or can be downloaded as a pdf. If the answer to a question is unknown leave the question blank, more than one box can be checked to reflect uncertainty and comments can be included to explain your choice. The next tab includes the vulnerability questions that are answered through spatial analysis of the data provided. For each question a map will show the data and a table will show the information extracted. The appropriate checkbox will be filled in based on the NatureServe guidelines, however a user may check or uncheck a box if they would like to adjust the value. If the data for the spatial analysis was not provided the map will be blank and the user may answer the question based on expert knowledge or leave it blank. The final tab shows the results of the climate change vulnerability index and some information about what factors had the most impact on the calculated index.  

## Run a demonstration
Before using the app to assess a real species we recommend walking through the app with the demo data set provided. Run the code below to get started.

```{r setup, eval=FALSE}
library(ccviR)
run_ccvi_app("demo")
```

### Getting started
The Welcome Tab provides information on the Index and the data needed to calculate it.

### Preparing the data
To start we will process the example climate data by clicking the Prepare Climate Data button. This opens a new tab. In this case we don't need to download the data because we are using the demo data. So you can start by selecting the folder location of raw climate data. In the file selector window expand the "clim_files" folder by clicking the arrow and select the "raw" folder. Note the names of the files on the right hand side, when you download the real climate data you will need to re-name the files to match this naming structure or select the files individually. Click "Select" to close the window. Do the same for the output folder, this time selecting the "processed" folder.  Check the "Should existing files in the output folder be overwritten?" box. Then click "Process". A loading symbol will appear and when it is finished a message saying "Processing complete" will appear. This will take longer for the real climate data that covers all of North America so you will need to wait until it is finished before moving on. When it is done click "Finished" to go back to the Welcome page. The next time you use the app you can go straight onto Step 1 without preparing the climate data because it is stored on your computer in the output folder that you selected.

For a real species you will then need to think about and acquire the data described in Steps 1 and 2 on the Welcome page but for the demonstration we go ahead and press "Start" to begin calculating the index.

### Species information
On this page you will provide some basic details about the species. Make sure to select the appropriate taxonomic group since some aspects of the index are conditional on this. For the demonstration select "Bird". See the NatureServe Guidelines to better understand the meaning of the two check boxes at the end. For the demonstration check the box for migratory species. Click "Next".

### Spatial data analysis
On this tab you will load the spatial data used by the index and see the results of the spatial analysis for exposure to climate change. Select the folder location of the climate data prepared in the previous step ie "clim_files > processed". Then select the range polygon for the species by selecting the file "rng_poly_high.shp". Select the assessment area by selecting the "assess_poly.shp" file. Select the "nonbreed_poly.shp" for the non-breeding range. Select "PTN_poly.shp" for the physiological thermal niche. And finally, select "HS_rast_high.tif" for the projected habitat change raster. New inputs will show up to specify how the raster should be classified into lost, gained, maintained or not suitable habitat. For the example use the default values, which are for a raster where lost is 1, maintained in 2-6,  gained is 7 and 0 is not suitable. Note if you wanted to ignore gains you could set the gain multiplier to 0 but we will leave it at 1 and assume that the model has already accounted for whether habitat gains are likely to be realized. Then click "Run". A loading symbol will appear while the data is being processed. Then interactive maps of climate change exposure will be displayed. The real climate data will cover all of North America. The exposure maps are classified into 6 classes and the proportion of the species range in each class is displayed in the table. The exposure multiplier is determined by the level of exposure and is used to modify the sensitivity and adaptive capacity components of the index based on exposure to climate change. A similar analysis is done for the non-breeding range of the species, see the NatureServe guidelines for a full description of how the migratory exposure index is calculated. Once you have finished exploring the maps click "Next".

### Vulnerability questions
Vulnerability questions are detailed questions that the index uses to score the species' indirect exposure, sensitivity, adaptive capacity and modeled or documented responses to climate change. Descriptions of how to interpret and score the questions are available in the NatureServe guidelines which are included as a pop-up if you click the "Show guidelines" button. Some vulnerability questions are answered based on an analysis of spatial data and these questions are dealt with on the next tab. For the demonstration you can select any check box that you want for each question, try a few different versions and see how it affects the result! Click "Next" to go to the next tab

### Spatial Vulnerability Questions
This tab includes the vulnerability questions that have a spatial component. Each question includes a map and table showing how the data has been summarized. The check box is pre-selected based on the spatial data analysis but can be changed if needed. Note that if the check box is changed and then the Run button on the Spatial Analysis page is clicked again you will see a warning that the value of the check boxes on this page will be updated to the value based on the re-run spatial analysis. The comments will not be affected though so you can explain the reason for any adjustments in the comments and then remake those adjustments if they are still applicable. 
For the demonstration leave the check boxes as they are and then click "Next". 

### Results

On the Results page click Calculate to calculate the index value. Once loaded this page gives the resulting index value and tables and graphs that explain how the index value was determined. These are explained in the app. Once you are finished with reviewing the results you can save the data as a csv file.

If you go back and change the answer to a vulnerability question you will need to click the Calculate button again to see the updated results. 

### Saving the app
The state of the app can be saved by clicking the save button at the bottom of the Results page. A pop up will appear that asks you to pick a location and name for a folder that will store the app data. Be sure to save this some where that is easy to remember because you will need to find it again to load the saved app. The folder name must have only letters or numbers and no spaces. This will create a folder with the given name containing two .rds files that store the values.

This will save the information entered into the app but it will not save the results so when the app is loaded from the saved file it will re-run the calculations. In addition, only the path to the spatial data is stored not the data itself so the app will not be able to load if data is moved or its name is changed. If the data has moved you will get an error message but you can go back to the Spatial Analysis tab and select the new file location and then press Run which will re-run the spatial analysis but keep the answers to the non-spatial vulnerability questions from the saved file. 

## Troubleshooting

If you have a problem in the app you can look at the output in the R console for a clue about what is going wrong. The output will include messages, warnings and any error messages that are produced. You can ignore warnings unless something else has gone wrong. Most errors will show in the app but in some situations the app will go grey and the error message can be found in the R console. 

If you have persistent problems with the app you can do the same analysis using the ccviR package. You will often be able to figure out what is causing the problem and return to the app. See `vignette("package_vignette", package = "ccviR")` for a tutorial on how to use the package.  

## References
Young, B. E., K. R. Hall, E. Byers, K. Gravuer, G. Hammerson, A. Redder, and K. Szabo. 2012. Rapid assessment of plant and animal vulnerability to climate change. Pages 129-150 in Wildlife Conservation in a Changing Climate, edited by J. Brodie, E. Post, and D. Doak. University of Chicago Press, Chicago, IL. https://doi.org/10.7208/9780226074641-007

Young, B. E., N. S. Dubois, and E. L. Rowland. 2015. Using the Climate Change Vulnerability Index to inform adaptation planning: lessons, innovations, and next steps. Wildlife Society Bulletin 39:174-181.


