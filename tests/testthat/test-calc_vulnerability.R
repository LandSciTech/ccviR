context("test calc_vulnerability functioning")
library(dplyr)
make_vuln_df <- function(val1, val2 = NA, cave = 0 , mig = 0){
  vuln_qs <- tribble(
    ~Species, ~Code, ~Value1, ~Value2,
    "test_sp", "Z2", cave, NA,
    "test_sp", "Z3", mig, NA,
    "test_sp", "B1", val1, val2,
    "test_sp", "B2a", val1, val2,
    "test_sp", "B2b", val1, val2,
    "test_sp", "B3", val1, val2,
    "test_sp", "C1", val1, val2,
    "test_sp", "C2ai", val1, val2,
    "test_sp", "C2aii", val1, val2,
    "test_sp", "C2bi", val1, val2,
    "test_sp", "C2bii", val1, val2,
    "test_sp", "C2c", val1, val2,
    "test_sp", "C2d", val1, val2,
    "test_sp", "C3", val1, val2,
    "test_sp", "C4a", val1, val2,
    "test_sp", "C4b", val1, val2,
    "test_sp", "C4c", -1, val2,
    "test_sp", "C4d", val1, val2,
    "test_sp", "C4e", val1, ifelse(is.na(val2), val2, -1),
    "test_sp", "C4f", val1, val2,
    "test_sp", "C4g", val1, val2,
    "test_sp", "C5a", val1, val2,
    "test_sp", "C5b", val1, val2,
    "test_sp", "C5c", val1, val2,
    "test_sp", "C6", val1, val2,
    "test_sp", "D1", val1, val2,
    "test_sp", "D2", val1, val2,
    "test_sp", "D3", val1, val2,
    "test_sp", "D4", val1, val2,
  )
  vuln_qs %>% mutate(Value3 = NA_real_, Value4 = NA_real_)
}

make_exp_df <- function(exp_lev){
  if(exp_lev == 1){
    lev6 <- c(5, 10, 10, 25, 25, 25)
  }
  if(exp_lev == 2){
    lev6 <- c(10, 12, 30, 25, 10, 5)
  }
  if(exp_lev == 3){
    lev6 <- rev(c(5, 10, 10, 25, 25, 25))
  }

  exp_df_out <- tribble(
    ~MAT_1, ~MAT_2, ~MAT_3, ~MAT_4, ~MAT_5, ~MAT_6, ~CMD_1, ~CMD_2, ~CMD_3, ~CMD_4, ~CMD_5, ~CMD_6, ~CCEI_1, ~CCEI_2, ~CCEI_3, ~CCEI_4, ~perc_non_breed_not_over_ccei, ~HTN_1, ~HTN_2, ~HTN_3, ~HTN_4, ~PTN, ~MAP_max, ~MAP_min, ~perc_lost, ~perc_gain, ~perc_maint, ~range_size,
    lev6[1], lev6[2], lev6[3], lev6[4], lev6[5], lev6[6], lev6[1], lev6[2], lev6[3], lev6[4], lev6[5], lev6[6], 40.8,	31.0,	23.3, 4.9, 0,	NA,	NA,	NA,	NA,	0,	8073,	216, NA,	NA,	NA,	3.16572E+12
    )

  exp_df_out
}



test_that("val 0 index is LV", {
  expect_equal(calc_vulnerability(make_exp_df(1), make_vuln_df(0),
                                  tax_grp = "Bird")$index,
               "LV")
})

test_that("score goes up with val and exp", {
  expect_gt(calc_vulnerability(make_exp_df(1), make_vuln_df(1),
                               tax_grp = "Bird")$b_c_score,
            calc_vulnerability(make_exp_df(1), make_vuln_df(0),
                               tax_grp = "Bird")$b_c_score)

  expect_gt(calc_vulnerability(make_exp_df(3), make_vuln_df(1),
                               tax_grp = "Bird")$b_c_score,
            calc_vulnerability(make_exp_df(2), make_vuln_df(1),
                               tax_grp = "Bird")$b_c_score)

})

test_that("monte carlo happens", {
  expect_message(calc_vulnerability(make_exp_df(3), make_vuln_df(1, 3),
                                    tax_grp = "Bird"),
                 "monte carlo")
})


test_that("sea level rise vulnerable leads to EV", {
  vuln_qs <- make_vuln_df(0)

  # make it meet criteria for slr vulnerable
  vuln_qs$Value1[3:7] <- c(3,3,1,1,3)

  # check that Monte carlo includes SLR
  vuln_qs$Value2[3] <- 0

  res <- calc_vulnerability(make_exp_df(1), vuln_qs, tax_grp = "Bird")

  # if SLR is not 3 then not EV
  vuln_qs$Value1[3] <- 1
  res2 <- calc_vulnerability(make_exp_df(1), vuln_qs, tax_grp = "Bird")

  expect_equal(res$index, "EV")
  expect_equal(res$conf_index, "Low")
  expect_equal(res2$index, "MV")
})

test_that("Migratory exposure happens when it is supposed to",{
  vuln_qs <- make_vuln_df(1, mig = 1)
  exp_df <- make_exp_df(1)

  # should have mig exp
  res <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird")
  expect_true(res$mig_exp != "N/A")

  # should not
  # wrong tax_grp
  res2 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Vascular Plant")
  expect_true(res2$mig_exp == "N/A")

  # migratory not checked in vuln qs
  vuln_qs <- make_vuln_df(1)
  res3 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird")
  expect_true(res3$mig_exp == "N/A")

  # CCEI data not provided
  vuln_qs <- make_vuln_df(1, mig = 1)
  exp_df <- mutate_at(exp_df, vars(matches("CCEI_\\d")), ~NA_real_)
  res4 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird")
  expect_true(res4$mig_exp == "N/A")
})


