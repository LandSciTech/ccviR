# test calc_vulnerability functioning

test_that("val 0 index is LV", {
  expect_message(v <- calc_vulnerability(test_exp_tbl(1),
                                         make_vuln_df("nm", 0),
                                         tax_grp = "Bird"),
                 "calculating vulnerability") %>%
    expect_message("finished vulnerability")
  expect_equal(v$index, "LV")

  expect_snapshot_value(v, style = "json2")
})

test_that("score goes up with val and exp", {
  expect_gt(calc_vulnerability(test_exp_tbl(1), make_vuln_df("nm",1),
                               tax_grp = "Bird")$b_c_score,
            calc_vulnerability(test_exp_tbl(1), make_vuln_df("nm",0),
                               tax_grp = "Bird")$b_c_score) %>%
    suppressMessages()

  expect_gt(calc_vulnerability(test_exp_tbl(3), make_vuln_df("nm",1),
                               tax_grp = "Bird")$b_c_score,
            calc_vulnerability(test_exp_tbl(2), make_vuln_df("nm",1),
                               tax_grp = "Bird")$b_c_score) %>%
    suppressMessages()

})

test_that("monte carlo happens", {
  expect_message(calc_vulnerability(test_exp_tbl(3), make_vuln_df("nm", 1, 3),
                                    tax_grp = "Bird", n_rnds = 10),
                 "monte carlo") %>%
    suppressMessages()

  # more complex monte carlo
  expect_message(
    res <- calc_vulnerability(test_exp_tbl(3), make_vuln_df("nm", 1,
                                                            rep(c(3,2), length.out = 27)),
                              tax_grp = "Bird", n_rnds = 100)
  )  %>%
    suppressMessages()
})


test_that("sea level rise vulnerable leads to EV", {
  withr::with_seed(123, {
    vuln_qs <- make_vuln_df("nm", 0)
    vuln_qs$Value1[29] <- 0 # Revert protected areas to non-spatial

    # make it meet criteria for slr vulnerable
    vuln_qs$Value1[3:7] <- c(3,3,1,1,3)

    # check that Monte carlo includes SLR
    vuln_qs$Value2[3] <- 0

    res <- calc_vulnerability(test_exp_tbl(1), vuln_qs, tax_grp = "Bird", n_rnds = 100) %>%
      suppressMessages()

    # if SLR is not 3 then not EV
    vuln_qs$Value1[3] <- 1
    res2 <- calc_vulnerability(test_exp_tbl(1), vuln_qs, tax_grp = "Bird", n_rnds = 100) %>%
      suppressMessages()
  })

  expect_equal(res$index, "EV")
  expect_equal(res$conf_index, "Low")
  expect_equal(res2$index, "MV")

  expect_snapshot_value(res, style = "json2")
  expect_snapshot_value(res2, style = "json2")
})

test_that("Migratory exposure happens when it is supposed to",{
  vuln_qs <- make_vuln_df("nm", 1, mig = 1)
  exp_df <- test_exp_tbl(1)

  # should have mig exp
  res <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird") %>%
    suppressMessages()
  expect_true(res$mig_exp != "N/A")

  # should not
  # wrong tax_grp
  res2 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Vascular Plant") %>%
    suppressMessages()
  expect_true(res2$mig_exp == "N/A")

  # migratory not checked in vuln qs
  vuln_qs <- make_vuln_df("nm", 1)
  res3 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird") %>%
    suppressMessages()
  expect_true(res3$mig_exp == "N/A")

  # CCEI data not provided
  vuln_qs <- make_vuln_df("nm", 1, mig = 1)
  exp_df <- mutate_at(exp_df, vars(matches("CCEI_\\d")), ~NA_real_)
  res4 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird") %>%
    suppressMessages()
  expect_true(res4$mig_exp == "N/A")

  expect_snapshot_value(res, style = "json2")
  expect_snapshot_value(res2, style = "json2")
  expect_snapshot_value(res3, style = "json2")
})

test_that("multiscenario input works", {
  file_dir <- system.file("extdata", package = "ccviR")

  hs <- raster::stack(file.path(file_dir, "rng_chg_45.tif"),
                      file.path(file_dir, "rng_chg_85.tif"))

  clim_vars_multi <- get_clim_vars(file.path(file_dir,
                                             "clim_files/processed"),
                                   scenario_names = c("RCP 4.5", "RCP 8.5"))

  sp_res <- analyze_spatial(st_read(file.path(file_dir, "rng_poly.shp"),
                                agr = "constant", quiet = TRUE),
                        st_read(file.path(file_dir, "assess_poly.shp"),
                                agr = "constant", quiet = TRUE),
                        clim_vars_multi,
                        hs_rast =  hs,
                        hs_rcl = matrix(c(NA, -1:1, c(0,1,2,3)), ncol = 2),
                        scenario_names = c("RCP 4.5", "RCP 8.5"))$spat_table %>%
    suppressMessages()

  vuln_qs <- make_vuln_df("nm", 0.5, mig = 1)

  res <- calc_vulnerability(sp_res, vuln_qs, "Bird") %>%
    suppressMessages()

  expect_true(all(res$scenario_name == c("RCP 4.5", "RCP 8.5")))

  expect_gt(res$b_c_score[2], res$b_c_score[1])
  # expect_gt(res$d_score[3], res$d_score[2])

  expect_snapshot_value(res, style = "json2")
})

