context("test calc_vulnerability functioning")
library(dplyr)

make_exp_df <- function(exp_lev){
  if(exp_lev == 1){
    lev6 <- c(5, 10, 10, 25, 25, 25)
  }
  if(exp_lev == 2){
    lev6 <- c(10, 12, 30, 25, 10, 5)
  }
  if(exp_lev == 3){
    lev6 <- rev(c(5, 10, 10, 25, 25, 25))
  }

  exp_df_out <- tribble(
    ~scenario_name, ~MAT_1, ~MAT_2, ~MAT_3, ~MAT_4, ~MAT_5, ~MAT_6, ~CMD_1, ~CMD_2, ~CMD_3, ~CMD_4, ~CMD_5, ~CMD_6, ~CCEI_1, ~CCEI_2, ~CCEI_3, ~CCEI_4, ~perc_non_breed_not_over_ccei, ~HTN_1, ~HTN_2, ~HTN_3, ~HTN_4, ~PTN, ~MAP_max, ~MAP_min, ~range_change, ~range_overlap, ~range_size,
    "Scn1", lev6[1], lev6[2], lev6[3], lev6[4], lev6[5], lev6[6], lev6[1], lev6[2], lev6[3], lev6[4], lev6[5], lev6[6], 40.8,	31.0,	23.3, 4.9, 0,	NA,	NA,	NA,	NA,	0,	8073,	216, NA,	NA,	3.16572E+12
    )

  exp_df_out
}



test_that("val 0 index is LV", {
  expect_equal(calc_vulnerability(make_exp_df(1), make_vuln_df("nm", 0),
                                  tax_grp = "Bird")$index,
               "LV")
})

test_that("score goes up with val and exp", {
  expect_gt(calc_vulnerability(make_exp_df(1), make_vuln_df("nm",1),
                               tax_grp = "Bird")$b_c_score,
            calc_vulnerability(make_exp_df(1), make_vuln_df("nm",0),
                               tax_grp = "Bird")$b_c_score)

  expect_gt(calc_vulnerability(make_exp_df(3), make_vuln_df("nm",1),
                               tax_grp = "Bird")$b_c_score,
            calc_vulnerability(make_exp_df(2), make_vuln_df("nm",1),
                               tax_grp = "Bird")$b_c_score)

})

test_that("monte carlo happens", {
  expect_message(calc_vulnerability(make_exp_df(3), make_vuln_df("nm", 1, 3),
                                    tax_grp = "Bird", n_rnds = 10),
                 "monte carlo")
})


test_that("sea level rise vulnerable leads to EV", {
  vuln_qs <- make_vuln_df("nm", 0)

  # make it meet criteria for slr vulnerable
  vuln_qs$Value1[3:7] <- c(3,3,1,1,3)

  # check that Monte carlo includes SLR
  vuln_qs$Value2[3] <- 0

  res <- calc_vulnerability(make_exp_df(1), vuln_qs, tax_grp = "Bird", n_rnds = 40)

  # if SLR is not 3 then not EV
  vuln_qs$Value1[3] <- 1
  res2 <- calc_vulnerability(make_exp_df(1), vuln_qs, tax_grp = "Bird", n_rnds = 40)

  expect_equal(res$index, "EV")
  expect_equal(res$conf_index, "Low")
  expect_equal(res2$index, "MV")
})

test_that("Migratory exposure happens when it is supposed to",{
  vuln_qs <- make_vuln_df("nm", 1, mig = 1)
  exp_df <- make_exp_df(1)

  # should have mig exp
  res <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird")
  expect_true(res$mig_exp != "N/A")

  # should not
  # wrong tax_grp
  res2 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Vascular Plant")
  expect_true(res2$mig_exp == "N/A")

  # migratory not checked in vuln qs
  vuln_qs <- make_vuln_df("nm", 1)
  res3 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird")
  expect_true(res3$mig_exp == "N/A")

  # CCEI data not provided
  vuln_qs <- make_vuln_df("nm", 1, mig = 1)
  exp_df <- mutate_at(exp_df, vars(matches("CCEI_\\d")), ~NA_real_)
  res4 <- calc_vulnerability(exp_df, vuln_qs, tax_grp = "Bird")
  expect_true(res4$mig_exp == "N/A")
})

test_that("multiscenario input works", {
  file_dir <- system.file("extdata", package = "ccviR")

  hs <- raster(file.path(file_dir, "HS_rast_high.tif"))

  # make hs2 less CC in same area
  hs2 <- raster(file.path(file_dir, "HS_rast_med.tif"))
  hs2[1:30,] <- hs2[31:60,]
  hs2[31:100,] <- 0

  clim_vars_multi <- get_clim_vars(file.path(file_dir,
                                             "clim_files/processed/multi_scenario"),
                                   scenario_names = c("RCP4.5", "RCP8.5"))

  sp_res <- run_spatial(st_read(file.path(file_dir, "rng_poly_high.shp"),
                                agr = "constant", quiet = TRUE),
                        st_read(file.path(file_dir, "assess_poly.shp"),
                                agr = "constant", quiet = TRUE),
                        clim_vars_multi,
                        non_breed_poly = st_read(file.path(file_dir, "nonbreed_poly.shp"),
                                                 agr = "constant", quiet = TRUE),
                        hs_rast =  raster::stack(hs2, hs),
                        hs_rcl = matrix(c(0:7, c(0,1,2,2,2,2,2,3)), ncol = 2),
                        scenario_names = c("RCP4.5", "RCP8.5"))$spat_table

  vuln_qs <- make_vuln_df("nm", 1, mig = 1)

  res <- calc_vulnerability(sp_res, vuln_qs, "Bird")

  expect_true(all(names(res) == c("RCP4.5", "RCP8.5")))

  expect_gt(res$RCP8.5$b_c_score, res$RCP4.5$b_c_score)
  expect_gt(res$RCP8.5$d_score, res$RCP4.5$d_score)
})

