#' Calculate the vulnerability index score
#'
#' Calculate the NatureServe Climate Change Vulnerability Index from the
#' completed inputs.
#'
#' Options for \code{tax_grp} are Vascular Plant, Nonvascular Plant, Lichen,
#' Invert-Insect, Invert-Mollusk, Invert-Other, Fish, Amphibian, Reptile,
#' Mammal, Bird
#'
#' @param spat_df data.frame of spatial inputs produced by \code{analyze_spatial}
#' @param vuln_df data.frame of answers to vulnerability questions. The format
#'   must match \code{\link{make_vuln_df}}.
#' @param tax_grp taxonomic group of the species. Must match one of the options
#'   below
#' @param n_rnds number of Monte Carlo repetitions for determining variability
#'   when multiple values are given for a factor
#'
#' @return A data.frame with 1 row per scenario and columns:
#' \describe{
#'   \item{scenario_name}{Name identifying the scenario}
#'   \item{index}{The index value as a string. EV: Extremely Vulnerable,
#'   HV: Highly Vulnerable, MV: Moderately Vulnerable, LV: Less Vulnerable,
#'   IE: Insufficient Evidence}
#'   \item{conf_index}{An index of the confidence in the index based on the
#'   monte carlo. Options are Low, Moderate, High, Very High or Insufficient Evidence.}
#'   \item{mc_results}{A data.frame with the b_c_score, d_score, and index for each monte carlo repitition}
#'   \item{mig_exp}{An index of the migratory exposure. Options are Low, Moderate, High, or "N/A"}
#'   \item{d_score}{Total score from section D the modelled response to climate change section}
#'   \item{b_c_score}{Total score from sections B and C the indirect exposure, sensitivity and adaptive capacity sections}
#'   \item{vuln_df}{Answers to each question plus any comments. Numerical scores correspond to:
#'    -1) Unknown, 0) Neutral, 1) Somewhat increase, 2) Increase, 3) Greatly increase.
#'    If there are 2 numbers then two boxes were checked and the average of the scores
#'    was used in the total score}
#'   \item{n_b_factors}{Number of factors scored in section B}
#'   \item{n_c_factors}{Number of factors scored in section C}
#'   \item{n_d_factors}{Number of factors scored in section D}
#'   \item{slr_vuln}{Whether the species' vulnerability to sea level rise and dispersal limitations led to an index of EV}
#' }
#'
#' @export
#'
#' @examples
#'
#' base_pth <- system.file("extdata", package = "ccviR")
#'
#' # scenario names
#' scn_nms <- c("RCP 4.5", "RCP 8.5")
#'
#' clim_vars <- get_clim_vars(file.path(base_pth, "clim_files/processed"),
#'                            scenario_names = scn_nms)
#'
#' spat_res <- analyze_spatial(
#'   range_poly = sf::read_sf(file.path(base_pth, "rng_poly.shp"), agr = "constant"),
#'   scale_poly = sf::read_sf(file.path(base_pth, "assess_poly.shp"), agr = "constant"),
#'   clim_vars_lst = clim_vars,
#'   hs_rast = terra::rast(c(file.path(base_pth, "rng_chg_45.tif"),
#'    file.path(base_pth, "rng_chg_85.tif"))),
#'   hs_rcl = matrix(c(-1, 0, 1, 1, 2, 3), ncol = 2),
#'   scenario_names = scn_nms
#' )
#'
#' # vulnerability factor table with score 1 (somewhat increase vulnerability)
#' # for all factors
#' vuln <- make_vuln_df("test_species", val1 = 1, mig = 1)
#'
#' v <- calc_vulnerability(spat_res$spat_table, vuln, "Bird")
#'
#' \dontrun{
#' # With protected areas
#'
#' spat_res <- analyze_spatial(
#'   range_poly = sf::read_sf(file.path(base_pth, "rng_poly.shp"), agr = "constant"),
#'   scale_poly = sf::read_sf(file.path(base_pth, "assess_poly.shp"), agr = "constant"),
#'   protected_rast = terra::rast("misc/protected_areas/pa_north_america.tif"),
#'   hs_rast = terra::rast(c(file.path(base_pth, "rng_chg_45.tif"),
#'                           file.path(base_pth, "rng_chg_85.tif"))),
#'   clim_vars_lst = clim_vars,
#'   hs_rcl = matrix(c(-1, 0, 1, 1, 2, 3), ncol = 2),
#'   scenario_names = scn_nms
#' )
#'
#' # Fill in vulnerability Questions
#' vuln <- make_vuln_df("test_species")
#' vuln$Value1[3:19] <- c(0, 0, 1, 0, -1, -1, -1, -1, 0, 0, 1, 0, 0, 1, 0, 0, 0)
#'
#' # include a second value to reflect uncertainty and trigger a monte carlo to
#' # determine confidence
#' vuln$Value2[3:5] <- c(2, 0, 0)
#'
#' v <- calc_vulnerability(spat_res$spat_table, vuln, "Bird")
#' v$vuln_df[[1]] %>% print(n = Inf)
#'
#' }
#'

calc_vulnerability <- function(spat_df, vuln_df, tax_grp, n_rnds = 1000){
  # Calculate temperature exposure based on proportion of each temperature
  # change class and whether cave dwelling
  # 1 is Very High

  # From Excel #=====
  # For temperature
  # IF(O6>0.5,"Very High",
  #    IF(SUM(O6,O7)>=0.75,"High",
  #       IF(SUM(O6:O8)>=0.6,"Med High",
  #          IF(SUM(O6:O9)>=0.4,"Med Low",
  #             IF(SUM(O6:O10)>=0.2,"Low","Insig")))))
  # IF(O12="Very High",2.4,
  #    IF(O12="High",2,
  #       IF(O12="med high",1.6,
  #          IF(O12="Med Low",1.2,
  #             IF(O12="low",0.8,0.4)))))

  # for moisture
  # IF(R6>=0.8,"Very High",
  #    IF(SUM(R6:R7)>=0.64,"High",
  #       IF(SUM(R6:R8)>=0.48,"Med High",
  #          IF(SUM(R6:R9)>=0.32,"Med Low",
  #             IF(SUM(R6:R10)>=0.16,"Low","Insig")))))
  # IF(R12="Very High",2,
  #    IF(R12="High",1.67,
  #       IF(R12="Med High",1.33,
  #          IF(R12="Med Low",1,
  #             IF(R12="Low",0.67,0.33)))))
  #=====
  vuln_nms_dif <- setdiff(c("Code", paste0("Value", 1:4), "Species"), names(vuln_df))

  if(length(vuln_nms_dif) > 0){
    stop("vuln_df is missing the required columns: ", vuln_nms_dif, call. = FALSE)
  }

  spat_nms <- c(paste0("MAT_", 1:6), paste0("CMD_", 1:6), paste0("CCEI_", 1:4),
                paste0("HTN_", 1:4), "PTN", "MAP_max", "MAP_min",
                "range_change", "range_overlap", "range_size")

  spat_nms_dif <- setdiff(spat_nms, names(spat_df))

  if(length(spat_nms_dif) > 0){
    stop("spat_df is missing the required columns: ",
         paste0(spat_nms_dif, collapse = ", "), call. = FALSE)
  }

  # Do multiple scenarios
  if(nrow(spat_df) > 1){
    spat_df_lst <- split(spat_df, spat_df$scenario_name)

    ret_lst <- purrr::map_dfr(spat_df_lst, calc_vulnerability, vuln_df, tax_grp, n_rnds,
                              .id = "scenario_name")

    return(ret_lst)
  }

  tax_grp_dif <- setdiff(tax_grp, c("Vascular Plant", "Nonvascular Plant", "Lichen",
                                    "Invert-Insect", "Invert-Mollusk", "Invert-Other",
                                    "Fish", "Amphibian", "Reptile", "Mammal", "Bird"))

  if(length(tax_grp_dif) > 0){
    stop("tax_grp must be one of: ",
         paste0(c("Vascular Plant", "Nonvascular Plant", "Lichen",
                  "Invert-Insect", "Invert-Mollusk", "Invert-Other",
                  "Fish", "Amphibian", "Reptile", "Mammal", "Bird"),
                collapse = ", "),
         ". Not ", tax_grp, call. = FALSE)
  }

  message("calculating vulnerability index ", spat_df$scenario_name)

  plant_taxa <- c("Vascular Plant", "Nonvascular Plant")
  cave <- vuln_df %>% filter(.data$Code == "Z2") %>% pull(.data$Value1)

  if(is.na(cave)){
    stop("in vuln_df Value1 for Code Z2, cave or groundwater obligate is NA but it must be 0 or 1",
         call. = FALSE)
  }

  if(is.na(vuln_df %>% filter(.data$Code == "Z3") %>% pull(.data$Value1))){
    stop("in vuln_df Value1 for Code Z3, migratory species is NA but it must be 0 or 1",
         call. = FALSE)
  }

  spat_df <- apply_spat_tholds(spat_df, cave)
  # Code the vulnerability section as 3 = Greatly increase, 2 = Increase, 1 =
  # Somewhat increase, 0 = Neutral and -1 = Unknown

  # vulnerability scores that come from spatial analysis and spat_df
  q <- vulnq_code_lu_tbl$Code[vulnq_code_lu_tbl$is_spatial == 1]
  vuln_df_sp <- select(spat_df, all_of(q)) %>%
    tidyr::pivot_longer(everything(), names_to = "Code", values_to = "Value1")

  vuln_df <- vuln_df %>%
    bind_rows(vuln_df_sp) %>%
    filter(!is.na(.data$Value1)) %>%
    group_by(.data$Code) %>%
    mutate(N = n()) %>%
    ungroup() %>%
    mutate(Value1 = case_when(.data$N > 1 & .data$Value1 == -1 ~ 999,
                              TRUE ~ .data$Value1)) %>%
    filter(.data$Value1 != 999) %>%
    group_by(.data$Code) %>%
    mutate(N = n()) %>%
    ungroup() %>%
    mutate(Value1 = case_when(.data$N > 1 & is.na(.data$Species) ~ 999,
                              TRUE ~ .data$Value1)) %>%
    filter(.data$Value1 != 999)

  vuln_df <- calc_vuln_score(vuln_df, spat_df)

  vuln_df <- filter_applicable_qs(vuln_df, tax_grp, plant_taxa)

  # determine sufficient data
  n_b_factors <- vuln_df %>% filter(stringr::str_detect(.data$Code, "B\\d.*")) %>%
    pull(.data$score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  n_c_factors <- vuln_df %>% filter(stringr::str_detect(.data$Code, "C\\d.*")) %>%
    pull(.data$score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  n_d_factors <- vuln_df %>% filter(stringr::str_detect(.data$Code, "D\\d.*")) %>%
    pull(.data$score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  # some of these conditions are input rules like species, and taxonomic group
  # are required and you cannot select 4 different values for a factor.
  suff_dat_all <- all(isTRUE(all.equal(spat_df %>% select(contains("MAT")) %>%
                                         sum(na.rm = TRUE),
                                       100, tolerance = 0.1)),
                      isTRUE(all.equal(spat_df %>% select(contains("CMD")) %>%
                                         sum(na.rm = TRUE),
                                       100, tolerance = 0.1)),
                      n_b_factors > 2,
                      n_c_factors > 9)

  # sea level rise is greatly increase, either anthro or nat barriers are
  # increase or greatly increase and dispersal is increase or greatly increase
  slr_vuln <- all(vuln_df %>% filter(.data$Code == "B1") %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) == 3,
                  vuln_df %>% filter(.data$Code %in% c("B2a", "B2b")) %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) >= 2,
                  vuln_df %>% filter(.data$Code == "C1") %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) >= 2)

  b_c_score <- vuln_df %>%
    filter(stringr::str_detect(.data$Code, "[B,C]\\d.*"), .data$score >= 0) %>%
    pull(.data$score) %>% sum(na.rm = TRUE)

  d_score <- vuln_df %>%
    filter(stringr::str_detect(.data$Code, "[D]\\d.*"), .data$score >= 0) %>%
    pull(.data$score) %>% sum(na.rm = TRUE)

  comb_index <- ind_from_vuln(b_c_score, d_score, slr_vuln,
                              d_ie = n_d_factors < 1,
                              b_c_ie = any(n_b_factors < 3, n_c_factors < 10),
                              suff_dat_all = suff_dat_all)

  # Migratory range exposure
  do_mig_exp <- all(tax_grp %in% c("Bird", "Mammal", "Invert-Insect"),
                    vuln_df %>% filter(.data$Code == "Z3") %>% pull(.data$Value1) == 1,
                    isTRUE(all.equal(spat_df %>% select(matches("CCEI_\\d")) %>%
                                sum(na.rm = TRUE), 100, tolerance = 0.1)))

  mig_exp_score <- spat_df$CCEI_4*7/100 + spat_df$CCEI_3*5/100 +
    spat_df$CCEI_2*3/100 + spat_df$CCEI_1/100

  mig_exp_index <- case_when(!do_mig_exp ~ "N/A",
                             mig_exp_score >= 4 ~ "High",
                             mig_exp_score >= 2 ~ "Moderate",
                             mig_exp_score >= 0 ~ "Low",
                             TRUE ~ "N/A")

  # Excel spread sheet does monte carlo if more than one box checked that
  # randomly picks which value to use and calculates vulnerability and then
  # checks the amount of variation in calculated vulnerability score

  # apply NAs in score to values so they stick in MC
  vuln_df <- vuln_df %>%
    mutate(across("Value1":"Value4", ~ifelse(is.na(.data$score) & !is.na(.x), -1, .x)))

  if(vuln_df$Value2 %>% na.omit() %>% length() > 0 && suff_dat_all){
    message("performing monte carlo")

    monte_df <- calc_ind_monte(vuln_df, n_rnds, d_ie = n_d_factors < 1)

    monte_classes <- monte_df$index %>%
      factor(levels = c( "EV", "HV", "MV", "LV", "IE")) %>%
      table() %>%
      prop.table() %>%
      as.data.frame(stringsAsFactors = FALSE) %>%
      `names<-`(c("index", "frequency"))

  } else {
    monte_classes <- comb_index %>%
      factor(levels = c( "EV", "HV", "MV", "LV", "IE")) %>%
      table() %>%
      prop.table() %>%
      as.data.frame(stringsAsFactors = FALSE) %>%
      `names<-`(c("index", "frequency"))

    monte_df <- data.frame(lst(b_c_score, d_score, index = comb_index))
  }
  conf_score <- filter(monte_classes, .data$index == comb_index) %>% pull(.data$frequency)
  conf_index <- case_when(comb_index == "IE" ~ "Insufficient Evidence",
                          conf_score > 0.9 ~ "Very High",
                          conf_score > 0.8 ~ "High",
                          conf_score > 0.6 ~ "Moderate",
                          TRUE ~ "Low")
  message("finished vulnerability")

  return(tibble(scenario_name = spat_df$scenario_name,
                index = comb_index,
              conf_index = conf_index,
              mc_results = list(monte_df),
              mig_exp = mig_exp_index,
              d_score = d_score,
              b_c_score = b_c_score,
              vuln_df = list(vuln_df),
              n_b_factors = n_b_factors,
              n_c_factors = n_c_factors,
              n_d_factors = n_d_factors,
              slr_vuln = slr_vuln))

}

get_n_factors <- function(vuln_df, x){
 vuln_df %>% filter(stringr::str_detect(.data$Code, paste0(x, "\\d.*"))) %>%
    pull(.data$score) %>% `>=`(0) %>% sum(na.rm = TRUE)
}
