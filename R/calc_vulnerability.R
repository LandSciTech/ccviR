#' Calculate the vulnerability index score
#'
#' Calculate the vulnerability index score from the completed inputs. Equivalent
#' to the Calculations sheet in the Excel version.
#'
#' @param df


calc_vulnerability <- function(exp_df, vuln_df){
  # Calculate temperature exposure based on proportion of each temperature
  # change class and whether cave dwelling
  # 1 is Very High

  # From Excel #=====
  # For temperature
  # IF(O6>0.5,"Very High",
  #    IF(SUM(O6,O7)>=0.75,"High",
  #       IF(SUM(O6:O8)>=0.6,"Med High",
  #          IF(SUM(O6:O9)>=0.4,"Med Low",
  #             IF(SUM(O6:O10)>=0.2,"Low","Insig")))))
  # IF(O12="Very High",2.4,
  #    IF(O12="High",2,
  #       IF(O12="med high",1.6,
  #          IF(O12="Med Low",1.2,
  #             IF(O12="low",0.8,0.4)))))

  # for moisture
  # IF(R6>=0.8,"Very High",
  #    IF(SUM(R6:R7)>=0.64,"High",
  #       IF(SUM(R6:R8)>=0.48,"Med High",
  #          IF(SUM(R6:R9)>=0.32,"Med Low",
  #             IF(SUM(R6:R10)>=0.16,"Low","Insig")))))
  # IF(R12="Very High",2,
  #    IF(R12="High",1.67,
  #       IF(R12="Med High",1.33,
  #          IF(R12="Med Low",1,
  #             IF(R12="Low",0.67,0.33)))))
  #=====

  exp_df1 <- exp_df %>% mutate(
    temp_exp = case_when(
      MAT_1 > 50 ~ 2.4,
      sum(MAT_1, MAT_2) >= 75 ~ 2,
      sum(MAT_1, MAT_2, MAT_3) >= 60 ~ 1.6,
      sum(MAT_1, MAT_2, MAT_3, MAT_4) >= 40 ~ 1.2,
      sum(MAT_1, MAT_2, MAT_3, MAT_4, MAT_5) >= 20 ~ 0.8,
      TRUE ~ 0.4
    ),
    temp_exp_cave = temp_exp / ifelse(cave == 1, 3, 1),
    moist_exp = case_when(
      CMD_1 >= 80 ~ 2,
      sum(CMD_1, CMD_2) >= 64 ~ 1.67,
      sum(CMD_1, CMD_2, CMD_3) >= 48 ~ 1.33,
      sum(CMD_1, CMD_2, CMD_3, CMD_4) >= 32 ~ 1,
      sum(CMD_1, CMD_2, CMD_3, CMD_4, CMD_5) >= 16 ~ 0.67,
      TRUE ~ 0.33
    ),
    moist_exp_cave = moist_exp / ifelse(cave == 1, 3, 1),
    comb_exp = mean(c(temp_exp, moist_exp)),
    comb_exp_cave = comb_exp / ifelse(cave == 1, 3, 1)
  )
  # Code the vulnerability section as 3 = Greatly increase, 2 = Increase, 1 =
  # Somewhat increase, 0 = Neutral and -1 = Unknown

  #TODO: Add vulnerability data from the dummyvuln.xlsx as example. Need to
  #figure out which exposure to use where and how to handle multiple
  #values/uncertainty
}
