#' Calculate the vulnerability index score
#'
#' Calculate the vulnerability index score from the completed inputs. Equivalent
#' to the Calculations sheet in the Excel version.
#'
#' @param exp_df data.frame of proportion of range in different classes
#' @param vuln_df data.frame of answers to vulnerability questions
#' @param n_rnds number of monte carlo repititions for determining variability
#'   when mutltiple values are given for a factor

# input rules: species, and taxonomic group are required and you cannot select 4
# different values for a factor. If taxonomic group is a plant, animal, or
# lichen different options for some C questions, get options for taxonomic group
# from excel. Can't select unknown and another box. Note NA has specific meaning
# of no response binary responses should never be NA ie cave.  Can override the
# spatially derived answers to questions in case there is other data that should
# be considered eg cave obligates could have C2ai of GI since they experience
# minimal temperature fluctuations if these questions are answered they will
# override the spatially derived ones


# vuln_df <- read.csv("data/outputs/dummyvuln.csv", stringsAsFactors = FALSE)
# exp_df <- read.csv("data/outputs/AMCO_NA_CAN_USA.csv") %>%
#   filter(scale == "CAN")
#
# vuln_df <- vuln_df %>% mutate_at(vars(3:7), ~case_when(.x == "Inc" ~ 2,
#                                             .x == "SI" ~ 1,
#                                             .x == "N" ~ 0,
#                                             .x == "U" ~ -1,
#                                             .x == "N/A" ~ NA_real_,
#                                             .x == "" ~ NA_real_,
#                                             .x == "1" ~ 1,
#                                             is.na(.x) ~ NA_real_,
#                                             TRUE ~ as.numeric(.x)))

calc_vulnerability <- function(exp_df, vuln_df, n_rnds = 1000){
  # Calculate temperature exposure based on proportion of each temperature
  # change class and whether cave dwelling
  # 1 is Very High

  # From Excel #=====
  # For temperature
  # IF(O6>0.5,"Very High",
  #    IF(SUM(O6,O7)>=0.75,"High",
  #       IF(SUM(O6:O8)>=0.6,"Med High",
  #          IF(SUM(O6:O9)>=0.4,"Med Low",
  #             IF(SUM(O6:O10)>=0.2,"Low","Insig")))))
  # IF(O12="Very High",2.4,
  #    IF(O12="High",2,
  #       IF(O12="med high",1.6,
  #          IF(O12="Med Low",1.2,
  #             IF(O12="low",0.8,0.4)))))

  # for moisture
  # IF(R6>=0.8,"Very High",
  #    IF(SUM(R6:R7)>=0.64,"High",
  #       IF(SUM(R6:R8)>=0.48,"Med High",
  #          IF(SUM(R6:R9)>=0.32,"Med Low",
  #             IF(SUM(R6:R10)>=0.16,"Low","Insig")))))
  # IF(R12="Very High",2,
  #    IF(R12="High",1.67,
  #       IF(R12="Med High",1.33,
  #          IF(R12="Med Low",1,
  #             IF(R12="Low",0.67,0.33)))))
  #=====
  message("calculating vulnerability index")
  cave <- vuln_df %>% filter(Code == "Z2") %>% pull(Value1)

  exp_df <- exp_df %>% mutate(
    temp_exp = case_when(
      MAT_1 > 50 ~ 2.4,
      sum(MAT_1, MAT_2, na.rm = TRUE) >= 75 ~ 2,
      sum(MAT_1, MAT_2, MAT_3, na.rm = TRUE) >= 60 ~ 1.6,
      sum(MAT_1, MAT_2, MAT_3, MAT_4, na.rm = TRUE) >= 40 ~ 1.2,
      sum(MAT_1, MAT_2, MAT_3, MAT_4, MAT_5, na.rm = TRUE) >= 20 ~ 0.8,
      TRUE ~ 0.4
    ),
    temp_exp_cave = temp_exp / ifelse(cave == 1, 3, 1),
    moist_exp = case_when(
      CMD_1 >= 80 ~ 2,
      sum(CMD_1, CMD_2, na.rm = TRUE) >= 64 ~ 1.67,
      sum(CMD_1, CMD_2, CMD_3, na.rm = TRUE) >= 48 ~ 1.33,
      sum(CMD_1, CMD_2, CMD_3, CMD_4, na.rm = TRUE) >= 32 ~ 1,
      sum(CMD_1, CMD_2, CMD_3, CMD_4, CMD_5, na.rm = TRUE) >= 16 ~ 0.67,
      TRUE ~ 0.33
    ),
    moist_exp_cave = moist_exp / ifelse(cave == 1, 3, 1),
    comb_exp = mean(c(temp_exp, moist_exp)),
    comb_exp_cave = comb_exp / ifelse(cave == 1, 3, 1),
    C2ai = case_when(HTN_4 > 10 ~ 0,
                     HTN_3 > 10 ~ 1,
                     HTN_2 > 10 ~ 2,
                     HTN_1 > 10 ~ 3),
    C2aii = case_when(PTN > 90 ~ 3,
                      PTN > 50 ~ 2,
                      PTN > 10 ~ 1,
                      TRUE ~ 0),
    range_MAP = MAP_max - MAP_min,
    C2bi = case_when(range_MAP < 100 ~ 3,
                     range_MAP < 254 ~ 2,
                     range_MAP < 508 ~ 1,
                     TRUE ~ 0),
    D2 = case_when(perc_lost > 99 ~ 3,
                   perc_lost > 50 ~ 2,
                   perc_lost > 20 ~ 1,
                   TRUE ~ 0),
    D3 = case_when(D2 == 3 ~ 0,
                   perc_maint == 0 ~ 3,
                   perc_maint < 30 ~ 2,
                   perc_maint < 60 ~ 1,
                   TRUE ~ 0))
  # Code the vulnerability section as 3 = Greatly increase, 2 = Increase, 1 =
  # Somewhat increase, 0 = Neutral and -1 = Unknown

  # vulnerability scores that come from spatial analysis and exp_df
  vuln_df_sp <- data.frame(Code = c("C2ai", "C2aii", "C2bi", "D2", "D3"),
                           Value1 = c(exp_df$C2ai, exp_df$C2aii, exp_df$C2bi,
                                      exp_df$D2, exp_df$D3),
                           stringsAsFactors = FALSE)

  vuln_df <- vuln_df %>% bind_rows(vuln_df_sp) %>%
    filter(!is.na(Value1)) %>%
    group_by(Code) %>%
    mutate(N = n()) %>%
    ungroup() %>%
    mutate(Value1 = case_when(N > 1 & is.na(Species) ~ 999,
                              TRUE ~ Value1)) %>%
    filter(Value1 != 999)

  vuln_df <- vuln_df %>%
    mutate(exp = case_when(Code %in% c("Z1", "Z2", "Z3") ~ NA_real_,
                           Code %in% c("B1", "D1", "D2", "D3", "D4") ~ 1,
                           Code %in% c("C2ai", "C2aii")~ exp_df$temp_exp_cave,
                           Code %in% c("C2bi", "C2bii")~ exp_df$moist_exp_cave,
                           TRUE ~ exp_df$comb_exp_cave)) %>%
    group_by(Code) %>%
    mutate(score = exp*mean(c(Value1, Value2, Value3, Value4),
                            na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(score = ifelse(score < 0, 0, score))

  b_c_score <- vuln_df %>% filter(stringr::str_detect(Code, "[B,C]\\d.*")) %>%
    pull(score) %>% sum(na.rm = TRUE)

  d_score <- vuln_df %>% filter(stringr::str_detect(Code, "[D]\\d.*")) %>%
    pull(score) %>% sum(na.rm = TRUE)

  # determine sufficient data
  n_b_factors <- vuln_df %>% filter(stringr::str_detect(Code, "B\\d.*")) %>%
    pull(score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  n_c_factors <- vuln_df %>% filter(stringr::str_detect(Code, "C\\d.*")) %>%
    pull(score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  n_d_factors <- vuln_df %>% filter(stringr::str_detect(Code, "D\\d.*")) %>%
    pull(score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  # some of these conditions are input rules like species, and taxonomic group
  # are required and you cannot select 4 different values for a factor.
  suff_dat_all <- all(all.equal(exp_df %>% select(contains("MAT")) %>%
                        sum(na.rm = TRUE), 100, tolerance = 0.1),
                      all.equal(exp_df %>% select(contains("CMD")) %>%
                        sum(na.rm = TRUE), 100, tolerance = 0.1),
                      n_b_factors > 2,
                      n_c_factors > 9)

  # Convert score to index
  b_c_index <- case_when(n_b_factors < 3 ~ "IE",
                         n_c_factors < 10 ~ "IE",
                         b_c_score > 10 ~ "EV",
                         b_c_score > 7 ~ "HV",
                         b_c_score > 4 ~ "MV",
                         TRUE ~ "LV")

  d_index <- case_when(n_d_factors < 1 ~ "IE",
                       d_score >= 6 ~ "EV",
                       d_score >= 4 ~ "HV",
                       d_score >= 2 ~ "MV",
                       TRUE ~ "LV")

  # sea level rise is greatly increase, either anthro or nat barriers are
  # increase or greatly increase and dispersal is increase or greatly increase
  slr_vuln <- all(vuln_df %>% filter(Code == "B1") %>%
                       select(matches("Value\\d")) %>%
                       max(na.rm = TRUE) == 3,
                  vuln_df %>% filter(Code %in% c("B2a", "B2b")) %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) >= 2,
                  vuln_df %>% filter(Code == "C1") %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) >= 2)

  comb_index_tbl <- data.frame(Dindex = c("EV", "HV", "MV", "LV", "IE"),
                               bc_ev = c("EV", "EV", "HV", "HV", "EV"),
                               bc_hv = c("EV", "HV", "HV", "MV", "HV"),
                               bc_mv = c("HV", "HV", "MV", "MV", "MV"),
                               bc_lv = c("HV", "MV", "LV", "LV", "LV"),
                               bc_ie = c("EV", "HV", "MV", "LV", "IE"),
                               stringsAsFactors = FALSE)

  col_bc_index <- which(comb_index_tbl$Dindex == b_c_index) + 1
  row_d_index <- which(comb_index_tbl$Dindex == d_index)

  comb_index <- case_when( slr_vuln ~ "EV",
                           !suff_dat_all ~ "IE",
                           TRUE ~ comb_index_tbl[row_d_index, col_bc_index])

  # Migratory range exposure
  do_mig_exp <- all(vuln_df %>% slice(1) %>% pull(1) %in%
                      c("Bird", "Mammal", "Invert-Insect"),
                    vuln_df %>% filter(Code == "Z3") %>% pull(Value1) == 1,
                    all.equal(exp_df %>% select(contains("CCEI")) %>%
                                sum(na.rm = TRUE), 100, tolerance = 0.1))

  mig_exp_score <- exp_df$CCEI_1*7/100 + exp_df$CCEI_2*5/100 +
    exp_df$CCEI_3*3/100 + exp_df$CCEI_4/100

  mig_exp_index <- case_when(!do_mig_exp ~ "N/A",
                             mig_exp_score >= 4 ~ "High",
                             mig_exp_score >= 2 ~ "Moderate",
                             TRUE ~ "Low")

  # Excel spread sheet does monte carlo if more than one box checked that
  # randomly picks which value to use and calculates vulnerability and then
  # checks the amount of variation in calculated vulnerability score

  if(vuln_df$Value2 %>% na.omit() %>% length() > 0 && suff_dat_all){
    message("performing monte carlo")
    # Note function uses objects from parent env check carefully!
    calc_ind_monte <- function(i){
      vuln_df <- vuln_df %>%
        group_by(Code) %>%
        mutate(n_vals = sum(!is.na(Value1), !is.na(Value2), !is.na(Value3),
                            !is.na(Value4)),
               rnd = runif(n()),
               val_to_use = which((1/n_vals*1:n_vals) ==
                                    min((1/n_vals*1:n_vals)[which((1/n_vals*1:n_vals) > rnd)])),
               val = case_when(val_to_use == 1 ~ Value1,
                               val_to_use == 2 ~ Value2,
                               val_to_use == 3 ~ Value3,
                               val_to_use == 4 ~ Value4),
               score = exp * val) %>%
        ungroup() %>%
        mutate(score = ifelse(score < 0, 0, score))


      b_c_score1 <- vuln_df %>% filter(stringr::str_detect(Code, "[B,C]\\d.*")) %>%
        pull(score) %>% sum(na.rm = TRUE)

      d_score1 <- vuln_df %>% filter(stringr::str_detect(Code, "[D]\\d.*")) %>%
        pull(score) %>% sum(na.rm = TRUE)

      # Convert score to index
      b_c_index <- case_when(n_b_factors < 3 ~ "IE",
                             n_c_factors < 10 ~ "IE",
                             b_c_score1 > 10 ~ "EV",
                             b_c_score1 > 7 ~ "HV",
                             b_c_score1 > 4 ~ "MV",
                             TRUE ~ "LV")

      d_index <- case_when(n_d_factors < 1 ~ "IE",
                           d_score1 >= 6 ~ "EV",
                           d_score1 >= 4 ~ "HV",
                           d_score1 >= 2 ~ "MV",
                           TRUE ~ "LV")

      # sea level rise is greatly increase, either anthro or nat barriers are
      # increase or greatly increase and dispersal is increase or greatly increase
      slr_vuln <- all(vuln_df %>% filter(Code == "B1") %>%
                        select(matches("Value\\d")) %>%
                        max(na.rm = TRUE) == 3,
                      vuln_df %>% filter(Code %in% c("B2a", "B2b")) %>%
                        select(matches("Value\\d")) %>%
                        max(na.rm = TRUE) >= 2,
                      vuln_df %>% filter(Code == "C1") %>%
                        select(matches("Value\\d")) %>%
                        max(na.rm = TRUE) >= 2)

      col_bc_index <- which(comb_index_tbl$Dindex == b_c_index) + 1
      row_d_index <- which(comb_index_tbl$Dindex == d_index)

      comb_index <- case_when( slr_vuln ~ "EV",
                               !suff_dat_all ~ "IE",
                               TRUE ~ comb_index_tbl[row_d_index, col_bc_index])
      return(comb_index)

    }
    monte_classes <- purrr::map_chr(1:n_rnds, calc_ind_monte) %>%
      table() %>%
      prop.table() %>%
      as.data.frame(stringsAsFactors = FALSE) %>%
      `names<-`(c("index", "frequency"))

  } else {
    monte_classes <- data.frame(index = comb_index, frequency = 1,
                                stringsAsFactors = FALSE)
  }
  conf_score <- filter(monte_classes, index == comb_index) %>% pull(frequency)
  conf_index <- case_when(comb_index == "IE" ~ "Insufficient Evidence",
                          conf_score > 0.9 ~ "Very High",
                          conf_score > 0.8 ~ "High",
                          conf_score > 0.6 ~ "Moderate",
                          TRUE ~ "Low")
  message("finished vulnerability")

  return(list(index = comb_index,
              conf_index = conf_index,
              index_conf = monte_classes,
              mig_exp = mig_exp_index,
              d_score = d_score,
              b_c_score = b_c_score))

}

