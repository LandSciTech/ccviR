#' Calculate the vulnerability index score
#'
#' Calculate the vulnerability index score from the completed inputs.
#'
#' Options for \code{tax_grp} are Vascular Plant, Nonvascular Plant, Lichen,
#' Invert-Insect, Invert-Mollusk, Invert-Other, Fish, Amphibian, Reptile,
#' Mammal, Bird
#'
#' @param spat_df data.frame of spatial inputs produced by \code{run_spatial}
#' @param vuln_df data.frame of answers to vulnerability questions. The format
#'   must match \code{\link{make_vuln_df}}.
#' @param tax_grp taxonomic group of the species. Must match one of the options
#'   below
#' @param n_rnds number of monte carlo repetitions for determining variability
#'   when multiple values are given for a factor
#'
#' @return A list:
#' \describe{
#'   \item{index}{The index value as a string. EV: Extremely Vulnerable,
#'   HV: Highly Vulnerable, MV: Moderately Vulnerable, LV: Less Vulnerable,
#'   IE: Insufficient Evidence}
#'   \item{conf_index}{An index of the confidence in the index based on the
#'   monte carlo. Options are Low, Moderate, High, Very High or Insufficient Evidence.}
#'   \item{mc_results}{A data.frame with the b_c_score, d_score, and index for each monte carlo repitition}
#'   \item{mig_exp}{An index of the migratory exposure. Options are Low, Moderate, High, or "N/A"}
#'   \item{d_score}{Total score from section D the modelled response to climate change section}
#'   \item{b_c_score}{Total score from sections B and C the indirect exposure, sensitivity and adaptive capacity sections}
#'   \item{vuln_df}{Answers to each question plus any comments. Numerical scores correspond to:
#'    -1) Unknown, 0) Neutral, 1) Somewhat increase, 2) Increase, 3) Greatly increase.
#'    If there are 2 numbers then two boxes were checked and the average of the scores
#'    was used in the total score}
#'   \item{n_b_factors}{Number of factors scored in section B}
#'   \item{n_c_factors}{Number of factors scored in section C}
#'   \item{n_d_factors}{Number of factors scored in section D}
#'   \item{slr_vuln}{Whether the species' vulnerability to sea level rise and dispersal limitations led to an index of EV}
#' }
#'
#' @export
#' @importFrom stats frequency na.omit runif
#' @importFrom utils write.csv
#'
#' @examples
#'
#' base_pth <- system.file("extData", package = "ccviR")
#'
#' clim_vars <- get_clim_vars(file.path(base_pth, "clim_files/processed"))
#'
#' spat_res <- run_spatial(
#'   range_poly = sf::read_sf(file.path(base_pth, "rng_poly_high.shp"), agr = "constant"),
#'   scale_poly = sf::read_sf(file.path(base_pth, "assess_poly.shp"), agr = "constant"),
#'   clim_vars_lst = clim_vars,
#'   hs_rast = raster::raster(file.path(base_pth, "HS_rast_high.tif")),
#'   hs_rcl = matrix(c(0:7, 0, 1, 2, 2 ,2, 2, 2, 3), ncol = 2)
#' )
#'
#' # vulnerability factor table with score 1 (somewhat increase vulnerability)
#' # for all factors
#' vuln <- make_vuln_df("test_species", val1 = 1, mig = 1)
#'
#' calc_vulnerability(spat_res$spat_table, vuln, "Bird")

calc_vulnerability <- function(spat_df, vuln_df, tax_grp, n_rnds = 1000){
  # Calculate temperature exposure based on proportion of each temperature
  # change class and whether cave dwelling
  # 1 is Very High

  # From Excel #=====
  # For temperature
  # IF(O6>0.5,"Very High",
  #    IF(SUM(O6,O7)>=0.75,"High",
  #       IF(SUM(O6:O8)>=0.6,"Med High",
  #          IF(SUM(O6:O9)>=0.4,"Med Low",
  #             IF(SUM(O6:O10)>=0.2,"Low","Insig")))))
  # IF(O12="Very High",2.4,
  #    IF(O12="High",2,
  #       IF(O12="med high",1.6,
  #          IF(O12="Med Low",1.2,
  #             IF(O12="low",0.8,0.4)))))

  # for moisture
  # IF(R6>=0.8,"Very High",
  #    IF(SUM(R6:R7)>=0.64,"High",
  #       IF(SUM(R6:R8)>=0.48,"Med High",
  #          IF(SUM(R6:R9)>=0.32,"Med Low",
  #             IF(SUM(R6:R10)>=0.16,"Low","Insig")))))
  # IF(R12="Very High",2,
  #    IF(R12="High",1.67,
  #       IF(R12="Med High",1.33,
  #          IF(R12="Med Low",1,
  #             IF(R12="Low",0.67,0.33)))))
  #=====
  vuln_nms_dif <- setdiff(c("Code", paste0("Value", 1:4), "Species"), names(vuln_df))

  if(length(vuln_nms_dif) > 0){
    stop("vuln_df is missing the required columns: ", vuln_nms_dif, call. = FALSE)
  }

  spat_nms <- c(paste0("MAT_", 1:6), paste0("CMD_", 1:6), paste0("CCEI_", 1:4),
                paste0("HTN_", 1:4), "PTN", "MAP_max", "MAP_min",
                "range_change", "range_overlap", "range_size")

  spat_nms_dif <- setdiff(spat_nms, names(spat_df))

  if(length(spat_nms_dif) > 0){
    stop("spat_df is missing the required columns: ",
         paste0(spat_nms_dif, collapse = ", "), call. = FALSE)
  }

  # Do multiple scenarios
  if(nrow(spat_df) > 1){
    spat_df_lst <- split(spat_df, spat_df$scenario_name)

    ret_lst <- purrr::map_dfr(spat_df_lst, calc_vulnerability, vuln_df, tax_grp, n_rnds,
                              .id = "scenario_name")

    return(ret_lst)
  }

  tax_grp_dif <- setdiff(tax_grp, c("Vascular Plant", "Nonvascular Plant", "Lichen",
                                    "Invert-Insect", "Invert-Mollusk", "Invert-Other",
                                    "Fish", "Amphibian", "Reptile", "Mammal", "Bird"))

  if(length(tax_grp_dif) > 0){
    stop("tax_grp must be one of: ",
         paste0(c("Vascular Plant", "Nonvascular Plant", "Lichen",
                  "Invert-Insect", "Invert-Mollusk", "Invert-Other",
                  "Fish", "Amphibian", "Reptile", "Mammal", "Bird"),
                collapse = ", "),
         ". Not ", tax_grp, call. = FALSE)
  }

  message("calculating vulnerability index ", spat_df$scenario_name)

  plant_taxa <- c("Vascular Plant", "Nonvascular Plant")
  cave <- vuln_df %>% filter(Code == "Z2") %>% pull(Value1)

  if(is.na(cave)){
    stop("in vuln_df Value1 for Code Z2, cave or groundwater obligate is NA but it must be 0 or 1",
         call. = FALSE)
  }

  if(is.na(vuln_df %>% filter(Code == "Z3") %>% pull(Value1))){
    stop("in vuln_df Value1 for Code Z3, migratory species is NA but it must be 0 or 1",
         call. = FALSE)
  }


  spat_df <- spat_df %>% rowwise() %>%
    mutate(
      temp_exp = case_when(
        MAT_6 > 50 ~ 2.4,
        sum(MAT_6, MAT_5, na.rm = TRUE) >= 75 ~ 2,
        sum(MAT_6, MAT_5, MAT_4, na.rm = TRUE) >= 60 ~ 1.6,
        sum(MAT_6, MAT_5, MAT_4, MAT_3, na.rm = TRUE) >= 40 ~ 1.2,
        sum(MAT_6, MAT_5, MAT_4, MAT_3, MAT_2, na.rm = TRUE) >= 20 ~ 0.8,
        TRUE ~ 0.4
      ),
      temp_exp_cave = temp_exp / ifelse(cave == 1, 3, 1),
      moist_exp = case_when(
        CMD_6 >= 80 ~ 2,
        sum(CMD_6, CMD_5, na.rm = TRUE) >= 64 ~ 1.67,
        sum(CMD_6, CMD_5, CMD_4, na.rm = TRUE) >= 48 ~ 1.33,
        sum(CMD_6, CMD_5, CMD_4, CMD_3, na.rm = TRUE) >= 32 ~ 1,
        sum(CMD_6, CMD_5, CMD_4, CMD_3, CMD_2, na.rm = TRUE) >= 16 ~ 0.67,
        TRUE ~ 0.33
      ),
      moist_exp_cave = moist_exp / ifelse(cave == 1, 3, 1),
      comb_exp = mean(c(temp_exp, moist_exp)),
      comb_exp_cave = comb_exp / ifelse(cave == 1, 3, 1),
      C2ai = case_when(HTN_1 > 10 ~ 0,
                       HTN_2 > 10 ~ 1,
                       HTN_3 > 10 ~ 2,
                       HTN_4 > 10 ~ 3,
                       is.na(HTN_1) ~ NA_real_),
      C2aii = case_when(PTN > 90 ~ 3,
                        PTN > 50 ~ 2,
                        PTN > 10 ~ 1,
                        is.na(PTN) ~ NA_real_,
                        TRUE ~ 0),
      range_MAP = MAP_max - MAP_min,
      C2bi = case_when(range_MAP < 100 ~ 3,
                       range_MAP < 254 ~ 2,
                       range_MAP < 508 ~ 1,
                       is.na(range_MAP) ~ NA_real_,
                       TRUE ~ 0),
      D2 = case_when(range_change > 99 ~ 3,
                     range_change > 50 ~ 2,
                     range_change > 20 ~ 1,
                     is.na(range_change) ~ NA_real_,
                     TRUE ~ 0),
      D3 = case_when(D2 == 3 ~ 0,
                     range_overlap == 0 ~ 3,
                     range_overlap < 30 ~ 2,
                     range_overlap < 60 ~ 1,
                     is.na(range_overlap) ~ NA_real_,
                     TRUE ~ 0))
  # Code the vulnerability section as 3 = Greatly increase, 2 = Increase, 1 =
  # Somewhat increase, 0 = Neutral and -1 = Unknown

  # vulnerability scores that come from spatial analysis and spat_df
  vuln_df_sp <- data.frame(Code = c("C2ai", "C2aii", "C2bi", "D2", "D3"),
                           Value1 = c(spat_df$C2ai, spat_df$C2aii, spat_df$C2bi,
                                      spat_df$D2, spat_df$D3),
                           stringsAsFactors = FALSE)

  vuln_df <- vuln_df %>% bind_rows(vuln_df_sp) %>%
    filter(!is.na(Value1)) %>%
    group_by(Code) %>%
    mutate(N = n()) %>%
    ungroup() %>%
    mutate(Value1 = case_when(N > 1 & Value1 == -1 ~ 999,
                              TRUE ~ Value1)) %>%
    filter(Value1 != 999) %>%
    group_by(Code) %>%
    mutate(N = n()) %>%
    ungroup() %>%
    mutate(Value1 = case_when(N > 1 & is.na(Species) ~ 999,
                              TRUE ~ Value1)) %>%
    filter(Value1 != 999)

  vuln_df <- vuln_df %>%
    mutate(exp = case_when(Code %in% c("Z1", "Z2", "Z3") ~ NA_real_,
                           Code %in% c("B1", "D1", "D2", "D3", "D4") ~ 1,
                           Code %in% c("C2ai", "C2aii")~ spat_df$temp_exp_cave,
                           Code %in% c("C2bi", "C2bii")~ spat_df$moist_exp_cave,
                           TRUE ~ spat_df$comb_exp_cave)) %>%
    group_by(Code) %>%
    mutate(score = exp*mean(c(Value1, Value2, Value3, Value4),
                            na.rm = TRUE)) %>%
    ungroup()

  # some qs should be NA for certain tax_grp
  C5a_unk <- vuln_df %>% filter(Code == "C5a") %>% pull(Value1) < 0
  C5b_unk <- vuln_df %>% filter(Code == "C5b") %>% pull(Value1) < 0

  vuln_df <- vuln_df  %>%
    mutate(score = case_when(Code == "C4b" & tax_grp %in% c(plant_taxa, "Lichen") ~
                               NA_real_,
                             Code == "C4c" & !tax_grp %in% plant_taxa ~ NA_real_,
                             Code == "C5b" & !C5a_unk ~ NA_real_,
                             Code == "C5c" & (!all(C5a_unk, C5b_unk) |
                               !tax_grp %in% plant_taxa) ~ NA_real_,
                             TRUE ~ score))


  # determine sufficient data
  n_b_factors <- vuln_df %>% filter(stringr::str_detect(Code, "B\\d.*")) %>%
    pull(score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  n_c_factors <- vuln_df %>% filter(stringr::str_detect(Code, "C\\d.*")) %>%
    pull(score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  n_d_factors <- vuln_df %>% filter(stringr::str_detect(Code, "D\\d.*")) %>%
    pull(score) %>% `>=`(0) %>% sum(na.rm = TRUE)

  # some of these conditions are input rules like species, and taxonomic group
  # are required and you cannot select 4 different values for a factor.
  suff_dat_all <- all(isTRUE(all.equal(spat_df %>% select(contains("MAT")) %>%
                                         sum(na.rm = TRUE),
                                       100, tolerance = 0.1)),
                      isTRUE(all.equal(spat_df %>% select(contains("CMD")) %>%
                                         sum(na.rm = TRUE),
                                       100, tolerance = 0.1)),
                      n_b_factors > 2,
                      n_c_factors > 9)

  # sea level rise is greatly increase, either anthro or nat barriers are
  # increase or greatly increase and dispersal is increase or greatly increase
  slr_vuln <- all(vuln_df %>% filter(Code == "B1") %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) == 3,
                  vuln_df %>% filter(Code %in% c("B2a", "B2b")) %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) >= 2,
                  vuln_df %>% filter(Code == "C1") %>%
                    select(matches("Value\\d")) %>%
                    max(na.rm = TRUE) >= 2)

  b_c_score <- vuln_df %>%
    filter(stringr::str_detect(Code, "[B,C]\\d.*"), score >= 0) %>%
    pull(score) %>% sum(na.rm = TRUE)

  d_score <- vuln_df %>%
    filter(stringr::str_detect(Code, "[D]\\d.*"), score >= 0) %>%
    pull(score) %>% sum(na.rm = TRUE)

  comb_index <- ind_from_vuln(b_c_score, d_score, slr_vuln,
                              d_ie = n_d_factors < 1,
                              b_c_ie = any(n_b_factors < 3, n_c_factors < 10),
                              suff_dat_all = suff_dat_all)

  # Migratory range exposure
  do_mig_exp <- all(tax_grp %in% c("Bird", "Mammal", "Invert-Insect"),
                    vuln_df %>% filter(Code == "Z3") %>% pull(Value1) == 1,
                    isTRUE(all.equal(spat_df %>% select(matches("CCEI_\\d")) %>%
                                sum(na.rm = TRUE), 100, tolerance = 0.1)))

  mig_exp_score <- spat_df$CCEI_4*7/100 + spat_df$CCEI_3*5/100 +
    spat_df$CCEI_2*3/100 + spat_df$CCEI_1/100

  mig_exp_index <- case_when(!do_mig_exp ~ "N/A",
                             mig_exp_score >= 4 ~ "High",
                             mig_exp_score >= 2 ~ "Moderate",
                             mig_exp_score >= 0 ~ "Low",
                             TRUE ~ "N/A")

  # Excel spread sheet does monte carlo if more than one box checked that
  # randomly picks which value to use and calculates vulnerability and then
  # checks the amount of variation in calculated vulnerability score

  # apply NAs in score to values so they stick in MC
  vuln_df <- vuln_df %>%
    mutate(across(Value1:Value4, ~ifelse(is.na(score) & !is.na(.x), -1, .x)))

  if(vuln_df$Value2 %>% na.omit() %>% length() > 0 && suff_dat_all){
    message("performing monte carlo")

    monte_df <- calc_ind_monte(vuln_df, n_rnds, d_ie = n_d_factors < 1)

    monte_classes <- monte_df$index %>%
      factor(levels = c( "EV", "HV", "MV", "LV", "IE")) %>%
      table() %>%
      prop.table() %>%
      as.data.frame(stringsAsFactors = FALSE) %>%
      `names<-`(c("index", "frequency"))

  } else {
    monte_classes <- comb_index %>%
      factor(levels = c( "EV", "HV", "MV", "LV", "IE")) %>%
      table() %>%
      prop.table() %>%
      as.data.frame(stringsAsFactors = FALSE) %>%
      `names<-`(c("index", "frequency"))

    monte_df <- data.frame(lst(b_c_score, d_score, index = comb_index))
  }
  conf_score <- filter(monte_classes, index == comb_index) %>% pull(frequency)
  conf_index <- case_when(comb_index == "IE" ~ "Insufficient Evidence",
                          conf_score > 0.9 ~ "Very High",
                          conf_score > 0.8 ~ "High",
                          conf_score > 0.6 ~ "Moderate",
                          TRUE ~ "Low")
  message("finished vulnerability")

  return(tibble(scenario_name = spat_df$scenario_name,
                index = comb_index,
              conf_index = conf_index,
              mc_results = list(monte_df),
              mig_exp = mig_exp_index,
              d_score = d_score,
              b_c_score = b_c_score,
              vuln_df = list(vuln_df),
              n_b_factors = n_b_factors,
              n_c_factors = n_c_factors,
              n_d_factors = n_d_factors,
              slr_vuln = slr_vuln))

}

