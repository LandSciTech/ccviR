<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Code Design • ccviR</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><link href="extra.css" rel="stylesheet"><meta property="og:title" content="Code Design"><meta property="og:image" content="https://landscitech.github.io/ccviR/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">ccviR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/app_vignette2.html">Using the ccviR App</a></li>
    <li><a class="dropdown-item" href="articles/data_prep_vignette.html">Preparing Custom Climate Data</a></li>
    <li><a class="dropdown-item" href="articles/package_vignette.html">Using the ccviR package</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/see24/ccviR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>Code Design</h1>
      <small class="dont-index">Source: <a href="https://github.com/see24/ccviR/blob/master/CODE_DESIGN.md" class="external-link"><code>CODE_DESIGN.md</code></a></small>
    </div>

<div id="code-design" class="section level1">

<p>Here are details regarding code design choices/decisions, particularly where things are bit convoluted, as well as style decisions or naming conventions.</p>
<div class="section level2">
<h2 id="data-storage">Data storage<a class="anchor" aria-label="anchor" href="#data-storage"></a></h2>
<p>Data used for preparing data sets for the package.</p>
<ul><li>Smaller data to be accessed by the user are stored in <code>inst/extdata</code>.</li>
<li>Large data or data which should not be shared directly, are stored in the <code>misc</code> folder which is Git-ignored. This ensures the same path for all developers and that data is kept within the project.</li>
<li>However, for reasons, R CMD Build actually copies all files to a temp folder and <em>then</em> deletes the ones in .Rbuildignore, which can create problems. The fix to this (if using RStudio) is to add <code>PKG_BUILD_COPY_METHOD=link</code> to your .Renviron file, which will link to those files rather than copying. (<a href="https://github.com/r-lib/pkgbuild/issues/59#issuecomment-1327752199" class="external-link uri">https://github.com/r-lib/pkgbuild/issues/59#issuecomment-1327752199</a>)</li>
</ul></div>
<div class="section level2">
<h2 id="workflow-style">Workflow style<a class="anchor" aria-label="anchor" href="#workflow-style"></a></h2>
<p>Workflows (i.e. not functions, but for example scripts to create internal data) use sections (# Header ——-) to create the TOC used in RStudio.</p>
</div>
<div class="section level2">
<h2 id="naming">Naming<a class="anchor" aria-label="anchor" href="#naming"></a></h2>
<ul><li>Snake case is used wherever possible</li>
<li>Test files are named <code>test-XX_DESCRIPTION.R</code>, where <code>XX</code> is the order they should be run (try to test lower order functions first).</li>
</ul></div>
<div class="section level2">
<h2 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h2>
<ul><li>
<code>aa_common_docs.R</code> holds documentation that is common to multiple functions. Use <code>@inheritParams</code> to pull out the documentation for function parameters from the common docs. If you include your own documentation for that parameter it will take precedence.</li>
</ul></div>
<div class="section level2">
<h2 id="random-code-bits">Random code bits<a class="anchor" aria-label="anchor" href="#random-code-bits"></a></h2>
<ul><li>
<code>!!!</code> Triple bang (or bang-bang-bang) - <a href="https://adv-r.hadley.nz/quasiquotation.html?q=" class="external-link uri">https://adv-r.hadley.nz/quasiquotation.html?q=</a>!!!#unquoting-many-arguments When you have a list, but you need the items to be arguments in a function one at a time. i.e., <code>tagList()</code> takes … so you need to do <code>tagList(div1, div2, div3)</code> So if you programatically create the divs, you have a list, then you can use <code>tagList(!!!list_of_divs)</code> to ‘explode’ them out (this is used a lot in the report).</li>
</ul></div>
<div class="section level2">
<h2 id="spatial-data">Spatial Data<a class="anchor" aria-label="anchor" href="#spatial-data"></a></h2>
<p>When creating our own spatial data, we use - Equal Area Albers projection for North America (i.e. ESRI:102008 for protected areas) - CRS 4326 (i.e. no projection) for CCEI raster - In <code><a href="reference/analyze_spatial.html">analyze_spatial()</a></code> data are transformed to match their overlapping datasets - Polygons are transformed to match the rasters - Most are matched to Mean Annual Temperature - Protected areas are matched to the projected range change rasters (hrasts) - Non-breeding polygon is transformed to CCEI projection - We transform to CRS 3857 for mapping (after simplifying, so it’s pretty speedy)</p>
<p>Sometimes raster data get’s weird when it’s transformed for maps (<a href="https://github.com/rspatial/terra/issues/1356" class="external-link uri">https://github.com/rspatial/terra/issues/1356</a>), where the NA values become super large. This creates a warning, but can otherwise be ignored <em>or</em> this can be fixed by loading the raster is loaded into memory. See <code>prep_raster_map()</code>.</p>
<p><strong>Speed</strong> - projecting and checking geometries in lat/lon coordinates (as opposed to projected data) is realllllly slow - try to clip all data before transforming - when matching CRS, try to transform non-complex data to match more complex data</p>
<p>For example, protected areas is a complicated polygon. So we first clip it to the assessment area (transform assessment area to match protected areas). Then we transform protected areas to match the hs raster.</p>
</div>
<div class="section level2">
<h2 id="inputs">Inputs<a class="anchor" aria-label="anchor" href="#inputs"></a></h2>
<p>Spatial inputs are created dynamically and update by using <code>updateInputsXX()</code> functions when re-loading data. This means that the inputs need to be available when loading the saved data, <em>before</em> the spatial data is available. Therefore, questions that <em>require</em> spatial data are created, but hidden until the spatial data is available. This way they can have the comments and evidence restored when re-loading data, and then it will be show after the spatial analyses rerun.</p>
</div>
<div class="section level2">
<h2 id="adding-new-inputs">Adding new inputs<a class="anchor" aria-label="anchor" href="#adding-new-inputs"></a></h2>
<p>This is a bit complicated with the saving and restoring process. - Make sure the the new input is included in the output of the module it is part of. - Add the new input name to the column_definitions_results.csv - Add the new input and the input_fun to shell.exec(here::here(“data-raw/ui_build_table.csv”)) - If the input_fun is a custom function create an update function of the form updateInput_fun. See updateCheck_comment_ui as an example. - Run all of data-raw/lookup_tbls.R - Test that the input is saved in the csv and updated on reloading</p>
</div>
<div class="section level2">
<h2 id="shiny-modules">Shiny Modules<a class="anchor" aria-label="anchor" href="#shiny-modules"></a></h2>
<div class="section level3">
<h3 id="namespacing">Namespacing<a class="anchor" aria-label="anchor" href="#namespacing"></a></h3>
<p>Namespacing can be a bit tricky in modules. In the simplest way, you just need to use the <code>NS()</code> function in the UI or the <code>ns</code> variable in the server (if using <code>renderUI()</code>, not required for anything else going to/from <code>output</code> or <code>input</code>)</p>
<ul><li>UI: Use <code>ns &lt;- NS(id)</code> at the start, wrap all UI ids in <code>ns(my_id)</code>
</li>
<li>Server: Use <code>ns &lt;- session$ns</code> at the start, then wrap ids in <code>ns(my_id)</code>.</li>
</ul><p><strong>Notes</strong></p>
<ul><li>We only need to use <code>ns(my_id)</code> in the server if creating our own UI elements i.e. with <code>renderUI()</code>
</li>
<li>In functions which dynamically create UIs, use <code>NS(id, ui_id)</code> <em>inside</em> the function, cf <code>get_file_ui()</code>
</li>
<li>
<code>conditionalPanel()</code> has a <code>ns</code> argument we should use (<a href="https://stackoverflow.com/a/76905697" class="external-link uri">https://stackoverflow.com/a/76905697</a>)</li>
<li>
<code>NS()</code> (or <code>ns</code>) is <em>not</em> required for shinyjs (mainly because always called within an observer, I believe)</li>
</ul></div>
<div class="section level3">
<h3 id="passing-variables-among-modules">Passing variables among modules<a class="anchor" aria-label="anchor" href="#passing-variables-among-modules"></a></h3>
<ul><li>We return reactives from a module like returning outputs from a function, put them in a list calling them by name (i.e. <code>spatial_data</code>, not <code>spatial_data()</code>)</li>
<li>Then pass them as arguments to other module functions</li>
<li>Remember that we want a list of reactives, not a reactive that returns a list (otherwise anytime any list item is updated, the whole reactive invalidates)</li>
</ul></div>
<div class="section level3">
<h3 id="circular-modules">Circular modules<a class="anchor" aria-label="anchor" href="#circular-modules"></a></h3>
<ul><li>The results and the save module are somewhat circular in that the index from results is passed to save and the output of save is used by results to create the report. This isn’t ideal, but allows us to keep both ui and server of the report module fully contained in the results module.</li>
</ul></div>
<div class="section level3">
<h3 id="checking-inputs-and-messages">Checking inputs and messages<a class="anchor" aria-label="anchor" href="#checking-inputs-and-messages"></a></h3>
<ul><li>Cannot use shinyFeedback for shinyFiles inputs</li>
<li>But can use validate(need()) on the <em>text outputs</em> to provide messages about file paths</li>
<li>To ensure that the spatial files are loaded early and to catch specific messages related to each file, we use ‘error’ verbatim textboxes that pass through any validate(need()) failures.</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h2>
<ul><li>It makes testing easier if, as much as possible, all code is moved into functions which can be tested individually, as well as used to create inputs for other parts of tests.</li>
<li>
<code>server_setup()</code> checks <code>is_testing()</code> to set the relative path correctly when running tests.</li>
<li>Consider running <code>devtools::test(filter = "test-FILE")</code> to test a single file in a ‘clean’ session. Helps find out why getting warnings which are once per session, for example, without have to re-run the entire set of tests.</li>
</ul><div class="section level3">
<h3 id="test-data">Test data<a class="anchor" aria-label="anchor" href="#test-data"></a></h3>
<ul><li>Most test data is stored in <code>inst/extdata</code> with the demo data</li>
<li>Most test data can be created on the fly by the <code>test_xxx()</code> functions (e.g., <code>test_files()</code>, <code>test_data()</code>, <code>test_spatial()</code>, depending on what you need for testing.</li>
<li>Some test files which are private are stored in <code>misc/external_test_files</code>. Tests using these files are skipped if the file doesn’t exist (e.g., test-01_checks.R tests for the M/Z dimensions)</li>
<li>Because terra rasters point to a C++ object (<a href="https://github.com/rspatial/terra/issues/161" class="external-link uri">https://github.com/rspatial/terra/issues/161</a>) and shinytest2 does <em>things</em>, we can’t actually pass rasters to an app for testing with shinytest2 (but no problem with interactive testing). This is why <code>mod_c_test()</code> accepts output of <code>test_files()</code> and then passes it to <code>test_data()</code> and then to <code>test_spatial()</code> internally (which ends up preserving the pointer location)</li>
<li>There are several saved progress files for testing different things (stored in <code>inst/extdata/test_files</code>)
<ul><li>
<code>test_full_run.csv</code> - Full run of a plant</li>
<li>
<code>test_full_run_migration.csv</code> - Full run for a migratory species</li>
<li>
<code>test_questions_only.csv</code> - Run with spatial and questions but no index</li>
<li>
<code>test_sp_changes.csv</code> - Full run of a plant, but some spatial questions changed</li>
<li>
<code>test_empty.csv</code> - An empty run file</li>
</ul></li>
</ul></div>
<div class="section level3">
<h3 id="interactive-testing">Interactive testing<a class="anchor" aria-label="anchor" href="#interactive-testing"></a></h3>
<ul><li>Most functions have an examples section in the roxygen2 docs which can be used for interactive testing.</li>
<li>Most Shiny modules have an explicit test function that can be used interactively
<ul><li>These generally have multiple settings for using pre-filled spatial file paths, or simulating loading data, or a vanilla run.</li>
</ul></li>
<li>Some examples use <code><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">withr::with_options()</a></code> to simulate certain conditions (e.g., <code>mod_report_test()</code>). In these cases the example must use <code>runApp()</code> or it doesn’t work (<a href="https://stackoverflow.com/a/78200567" class="external-link uri">https://stackoverflow.com/a/78200567</a>).</li>
</ul></div>
<div class="section level3">
<h3 id="testserver">testServer()<a class="anchor" aria-label="anchor" href="#testserver"></a></h3>
<ul><li>Where possible, testing is performed with the <code>testServer()</code> (Rather than shinytest2) <a href="https://mastering-shiny.org/scaling-testing.html#testing-reactivity" class="external-link uri">https://mastering-shiny.org/scaling-testing.html#testing-reactivity</a>
</li>
<li>See <code>?MockShinySession</code> for some of what you can access in the testServer</li>
<li>Can’t test input recovery from previous data because doesn’t work with <code>update*()</code> family of functions (<a href="https://mastering-shiny.org/scaling-testing.html#limitations" class="external-link uri">https://mastering-shiny.org/scaling-testing.html#limitations</a>)</li>
<li>Can use <code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> inside <code>testServer({...})</code> to interactively test and set up expectations.</li>
<li>Errors implying that cannot find bottom of stack (“Can’t find <code>bottom</code> on the call tree”) usually just mean that the snapshot has changed, so use <code>snapshot_review()</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="shinytest2">shinytest2<a class="anchor" aria-label="anchor" href="#shinytest2"></a></h3>
<ul><li><strong>You MUST rebuild the package before running Shiny tests!</strong></li>
<li>see <code><a href="https://rstudio.github.io/shinytest2/reference/AppDriver.html" class="external-link">?shinytest2::AppDriver</a></code> for some of what you can access form the <code>AppDriver</code>
</li>
<li>shinytest2 can be a bit finicky, but once you get the details right it works well</li>
<li>Careful: if you have a general error that won’t allow the app to work, running that tests can delete the snapshots. If that happens, revert that change in git, fix the app problem then retry.</li>
<li>Errors in the test pane that imply the app isn’t working (not that specific tests are failing) are best troubleshooted by calling the app interactively, or by using <code>record_test()</code> (don’t actually record it, but the errors messages are much better in this mode, and may be something as simple as misspelling a function name, for example)</li>
<li>Errors like “Unable request data from server” when trying to get snapshots may indicate that there is something wrong with the “Save progress” step. Run the app interactively and see what happens when you click “Save progress” at that step in the application run.</li>
<li>Because the app is running from a function, <code>record_test()</code> can be used to create the details of the test, but not the whole test file (you need to copy the code and add it to an existing test).</li>
<li>shinyFiles is a pain to test (because it uses actionButtons, which shinytest2 insists can only be ‘clicked’ not set to file values), so we don’t test the actual loading directly.</li>
<li>Clicking on modal buttons: <a href="https://github.com/rstudio/shinytest/issues/227" class="external-link uri">https://github.com/rstudio/shinytest/issues/227</a>
</li>
<li>comments about “shiny.testmode” being set are almost always red herrings and point out a general error in the app.</li>
<li>If snapshots keep changing by a small amount, add a Sys.sleep(1) to force the test to wait until it’s ready</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="random-notes">Random Notes<a class="anchor" aria-label="anchor" href="#random-notes"></a></h2>
<div class="section level3">
<h3 id="shinytest2-error-target-position-can-only-be-set-for-new-windows">shinytest2 error: “Target position can only be set for new windows”<a class="anchor" aria-label="anchor" href="#shinytest2-error-target-position-can-only-be-set-for-new-windows"></a></h3>
<ul><li>This happened after a Google Chrome update (<a href="https://stackoverflow.com/questions/79488849/target-position-can-only-be-set-for-new-windows-in-chromote-in-r/79489622#79489622" class="external-link uri">https://stackoverflow.com/questions/79488849/target-position-can-only-be-set-for-new-windows-in-chromote-in-r/79489622#79489622</a>)</li>
<li>Solution is to update chromote package to &gt;v0.5.0</li>
</ul></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sarah Endicott, Ilona Naujokaitis-Lewis.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

